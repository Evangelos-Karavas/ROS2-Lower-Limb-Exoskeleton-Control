<?xml version="1.0" encoding="utf-8" ?>

<robot name="exo" xmlns:xacro="http://www.ros.org/wiki/xacro">
  <xacro:property name="robot_name" value="exo" />
  <!-- Grab the joint limits. -->
  <xacro:include filename="$(find exo_description)/urdf/lleap_exo_joint_limits.xacro" />
  <xacro:include filename="$(find exo_description)/urdf/exo_material_colors.xacro"/>
  <xacro:include filename="$(find exo_description)/urdf/exo_gazebo_extentions.xacro"/>
  <xacro:include filename="$(find exo_description)/urdf/exo_ros2_control.xacro"/>
  <!-- link names; 1-3 map to .STL filenames -->
  <xacro:property name="link0" value="hip_base" />
  <xacro:property name="link1" value="thigh" />
  <xacro:property name="link2" value="shank" />
  <xacro:property name="link3" value="foot" />
  <!-- simple geometry properties -->
  <xacro:property name="torso_width" value="0.5"/>   <!-- in meters -->
  <!-- repeated leg joint names -->
  <xacro:property name="joint0" value="pelvis" /> <!-- hip base to torso; fixed! -->
  <xacro:property name="joint1" value="hip" />    <!-- fixed to thigh -->
  <xacro:property name="joint2" value="knee" />   <!-- thigh to shank -->
  <xacro:property name="joint3" value="ankle" />  <!-- shank to foot -->
  <xacro:property name="origin_y_thigh" value="0.043454"/>

  <!-- Foot sole contact -->
  <xacro:property name="foot_size_y" value="0.10"/>  <!-- width (side-to-side) -->
  <xacro:property name="foot_size_z" value="0.17"/>  <!-- length (forward) -->
  <xacro:property name="sole_thick"  value="0.001"/>
  <!-- === Allowing X and Z axis only === -->
  <link name="base_link">
    <inertial>
      <origin xyz="0 0 0.5" rpy="0 0 0"/>
      <mass value="1.0"/>
      <inertia ixx="0.1041667" ixy="0" ixz="0"
              iyy="0.0885417" iyz="0"
              izz="0.0260417"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0.5" rpy="0 0 0"/>
      <geometry><box size="0.25 0.5 1"/></geometry>
      <material name="red"/>
    </visual>
    <collision>
      <origin xyz="0 0 0.5" rpy="0 0 0"/>
      <geometry><box size="0.25 0.5 1"/></geometry>
    </collision>
  </link>
  <link name="world"/>
  <link name="slider_z">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.1"/>
      <inertia ixx="0.0002083" ixy="0" ixz="0"
              iyy="0.0002083" iyz="0"
              izz="0.0002083"/>
    </inertial>
    <collision><geometry><sphere radius="0.01"/></geometry></collision>
    <visual><geometry><sphere radius="0.01"/></geometry></visual>
  </link>

  <link name="slider_x">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.1"/>
      <inertia ixx="0.0002083" ixy="0" ixz="0"
              iyy="0.0002083" iyz="0"
              izz="0.0002083"/>
    </inertial>
    <collision><geometry><sphere radius="0.01"/></geometry></collision>
    <visual><geometry><sphere radius="0.01"/></geometry></visual>
  </link>
  <joint name="base_z" type="prismatic">
    <origin xyz="0 0 0" rpy="0 0 ${pi}"/>
    <parent link="world"/>
    <child link="slider_z"/>
    <axis xyz="0 0 1"/>
    <limit lower="-0.5" upper="0.5" effort="500" velocity="1.0"/>
    <dynamics damping="5.0" friction="1.0"/>
  </joint>
  <joint name="base_x" type="prismatic">
    <origin xyz="0 0 0" rpy="0 0 0"/>
    <parent link="slider_z"/>
    <child link="slider_x"/>
    <axis xyz="1 0 0"/>
    <limit lower="-5.0" upper="10.0" effort="500" velocity="1.0"/>
    <dynamics damping="5.0" friction="0.5"/>
  </joint>
  <joint name="base_to_body" type="fixed">
    <parent link="slider_x"/>
    <child link="base_link"/>
  </joint>

  <xacro:macro name="leg" params="prefix reflect">
    <joint name="${prefix}_${joint0}_fixed_joint" type="fixed">
      <origin xyz="0.00012638 ${reflect * torso_width/2} -0.0003763" rpy="0 0 0" />
      <parent link="base_link"/>
      <child link="${prefix}_${link0}"/>
      <axis xyz="-0.0029081 -0.99996 0.0086592" />
      <limit lower="-2.5" upper="2.5" effort="700" velocity="5" />
    </joint>

    <link name="${prefix}_${link0}">
      <inertial>
        <origin xyz="-0.0281418142029674 0.084195220690108 0.0136945077855137" rpy="0 0 0" />
        <mass value="1.40107341049644" />
        <inertia ixx="0.0057559217437971" ixy="0.000406518233708888" ixz="0.00153929909288236" iyy="0.0114198233883461" iyz="-0.000159377837584594" izz="0.00876258360043916" />
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="file://$(find exo_description)/meshes/${link0}.STL"/>
        </geometry>
        <material name="dark_gray"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>  
          <mesh filename="file://$(find exo_description)/meshes/${link0}.STL"/>
        </geometry>
      </collision>
    </link>
    <!-- Hip abduction - adduction -->
    <link name="${prefix}_hip_roll_link">
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <mass value="0.001"/>
        <inertia ixx="1e-6" ixy="0" ixz="0" iyy="1e-6" iyz="0" izz="1e-6"/>
      </inertial>
    </link>

    <xacro:if value="${int(reflect) &lt; 0}">
      <xacro:property name="origin_y_thigh" value="0.123454"/>
    </xacro:if>
    <!-- hip joint: fixed hip base to thigh (link1) -->
    <joint name="${prefix}_hip_roll_revolute_joint" type="revolute">
      <!-- keep the SAME origin + rpy as your old hip joint -->
      <origin xyz="0.00012638 ${origin_y_thigh} -0.0003763" rpy="${pi / 2} ${pi / 2} ${pi}" />
      <parent link="${prefix}_${link0}" />
      <child link="${prefix}_hip_roll_link" />
      <!-- roll axis (in this joint frame) -->
      <axis xyz="1 0 0" />
      <limit lower="-0.6" upper="0.6" effort="250" velocity="2.0"/>
      <dynamics damping="0.6" friction="0.2"/>
    </joint>

    <joint name="${prefix}_${joint1}_revolute_joint" type="revolute">
      <origin xyz="0 0 0" rpy="0 0 0" />
      <parent link="${prefix}_hip_roll_link" />
      <child link="${prefix}_${link1}" />
      <axis xyz="0 0 1" />
      <limit lower="-1.5" upper="1.5" effort="700" velocity="5" />
      <dynamics damping="0.3" friction="0.1"/>
    </joint>
    <!-- link1 should be the thigh (joint1 to joint2). In our current STL model, contains the parts of the hip and knee joint visuals. -->
    <link name="${prefix}_${link1}">
      <inertial>
        <origin xyz="-0.404990833485201 0.00723950792302919 -0.0848264671155734" 
                rpy="${pi / 2} 0 ${-(180 - 12) * pi / 180}" />
        <mass value="2.27289407400542" />
        <inertia ixx="0.00167557501769417" ixy="-8.47541360240001E-06" ixz="-0.00126944670009916" iyy="0.00777922506609577" iyz="-2.94088009595002E-06" izz="0.00736726690967362" />
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="${pi / 2} 0 ${-(180 - 12) * pi / 180}" />
        <geometry>
          <mesh filename="file://$(find exo_description)/meshes/${link1}.STL"/>
        </geometry>
        <material name="dark_gray"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="${pi / 2} 0 ${-(180 - 12) * pi / 180}" />
        <geometry>
          <mesh filename="file://$(find exo_description)/meshes/${link1}.STL"/>
        </geometry>
      </collision>
    </link>

    <!-- knee joint: thigh (link1) to shank (link2)-->
    <joint name="${prefix}_${joint2}_revolute_joint" type="revolute">
      <!--<origin xyz="-0.63585 0.033681 -0.13506" rpy="0 0 0" />-->
      <origin xyz="0.649 0.001 0.03402" rpy="0 0 0" />
      <parent link="${prefix}_${link1}" />
      <child link="${prefix}_${link2}" />
      <axis xyz="0 0 1" />
      <!-- Positional joint limits partially based on Tamar's msts (lower lim here). -->
      <limit lower="-10.0" upper="0.0" effort="250" velocity="1.308" />
      <dynamics damping="0.4" friction="1.0"/>
    </joint>

    <!-- link2 should be the shank (joint2 to joint3).
          In our current STL model, contains part of the knee joint visual. -->
    <link name="${prefix}_${link2}">
      <inertial>
        <origin xyz="-0.210873385399549 -0.0276710830621445 -0.140982468689507" 
                rpy="${pi / 2} 0 ${-(180 - 34) * pi / 180}" />
        <mass value="1.10275445439595" />
        <inertia ixx="0.00199044634689737" ixy="-7.54331572697175E-06" ixz="-0.00260077424938593" iyy="0.00581565190920448" iyz="-4.96554466328964E-06" izz="0.00412555905043524" />
      </inertial>
      <visual>
        <!-- y part of rpy again from digital screenshot measurement -->
        <origin xyz="0 0 0" rpy="${pi / 2} 0 ${-(180 - 34) * pi / 180}" />
        <geometry>
          <mesh filename="file://$(find exo_description)/meshes/${link2}.STL"/>
        </geometry>
        <material name="dark_gray"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="${pi / 2} 0 ${-(180 - 34) * pi / 180}" />
        <geometry>
          <mesh filename="file://$(find exo_description)/meshes/${link2}.STL"/>
        </geometry>
      </collision>
    </link>

    <link name="${prefix}_ankle_roll_link">
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <mass value="0.001"/>
        <inertia ixx="1e-6" ixy="0" ixz="0" iyy="1e-6" iyz="0" izz="1e-6"/>
      </inertial>
    </link>

    <joint name="${prefix}_ankle_roll_revolute_joint" type="revolute">
      <origin xyz="${0.475 + 0.075} 0.003 -0.03" rpy="0 0 0" />
      <parent link="${prefix}_${link2}" />
      <child link="${prefix}_ankle_roll_link" />
      <axis xyz="1 0 0" />
      <limit lower="-0.5" upper="0.5" effort="200" velocity="2.0"/>
      <dynamics damping="0.8" friction="0.3"/>
    </joint>

    <!-- ankle joint: shank (link2) to foot ('link3') -->
    <joint name="${prefix}_${joint3}_revolute_joint" type="revolute">
      <origin xyz="0 0 0" rpy="0 0 0" />
      <parent link="${prefix}_ankle_roll_link" />
      <child link="${prefix}_${link3}" />
      <axis xyz="0 0 1" />
      <limit lower="-1.0" upper="1.0" effort="250" velocity="1.308"/>
      <dynamics damping="0.7" friction="0.5"/>
    </joint>

    <!-- link3 should be the foot. -->
    <link name="${prefix}_${link3}">
      <inertial>
        <mass value="1.10275445439595" />
        <inertia ixx="0.00199044634689737" ixy="-7.54331572697175E-06" ixz="-0.00260077424938593" iyy="0.00581565190920448" iyz="-4.96554466328964E-06" izz="0.00412555905043524" />
      </inertial>
      <visual>
        <origin xyz="0 0.05 0" rpy="${pi / 2} 0 0" />
        <geometry>
          <box size="0.03 0.1 0.17"/>
        </geometry>
        <material name="red"/>
      </visual>
      <collision>
        <origin xyz="0 0.05 0" rpy="${pi / 2} 0 0" />
        <geometry>
          <box size="0.03 0.1 0.17"/>
        </geometry>
      </collision>
    </link>

    <!-- Extra joint + link for sole contact sensor -->
    <joint name="${prefix}_foot_to_sole_sensor" type="fixed">
      <origin xyz="0.015 0.05 0" rpy="0 ${pi/2} 0"/>
      <parent link="${prefix}_${link3}"/>
      <child link="${prefix}_sole_sensor"/>
    </joint>

    <link name="${prefix}_sole_sensor">
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <mass value="0.001"/>
        <inertia ixx="1e-6" ixy="0" ixz="0" iyy="1e-6" iyz="0" izz="1e-6"/></inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 ${pi/2} ${pi/2}"/>
        <geometry>
          <box size="${sole_thick} ${foot_size_y} ${foot_size_z}"/>
        </geometry>
        <material name="orange"/>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 ${pi/2} ${pi/2}"/>
        <geometry>
          <box size="${sole_thick} ${foot_size_y} ${foot_size_z}"/>
        </geometry>
      </collision>
    </link>

  </xacro:macro>

  <!-- Legs actually created. -->
  <xacro:leg prefix="right" reflect="1" />
  <xacro:leg prefix="left" reflect="-1.75" />
  <!-- Gazebo sensors and ros2_control plugin-->
  <xacro:exo_gazebo_extensions/>
  <xacro:exo_ros2_control/>
</robot>